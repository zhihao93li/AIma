
# Web产品需求文档（详细版）

## 1. 概述
本项目旨在开发一款Web应用，主要功能是帮助用户生成极具创意和嘲讽意味的骂人内容。该应用将通过对接DeepSeek API来实现内容生成，并逐步集成用户认证、积分系统及支付功能。

## 2. 分阶段开发计划

### 2.1 第一期：接入DeepSeek API并实现基本功能
**目标**：实现用户输入参考信息，系统调用DeepSeek API返回骂人内容。

**具体功能**：
- **用户界面**：提供一个对话框供用户输入参考信息。
- **API调用**：根据用户输入的信息调用DeepSeek API生成回复内容，并显示给用户。
- **错误处理**：处理API请求失败的情况（如网络问题、API错误等），并给出友好的提示信息。
- **内容合规**：添加基本的内容审核机制，确保生成内容符合法律法规。
- **使用条款**：添加简单的使用条款和免责声明。

### 2.2 第二期：实现用户登录功能
**目标**：增加用户注册与登录功能。

**具体功能**：
- **邮箱注册与登录**：用户可以直接使用谷歌邮箱授权登录，使用Supabase的授权系统。
- **数据存储**：使用Supabase进行用户数据和应用数据的存储。
- **安全性**：确保数据传输加密，保护用户隐私。
- **用户面板**：简单的用户信息管理界面，显示基本信息和使用记录。

### 2.3 第三期：实现积分消耗与分享赚取积分功能
**目标**：引入积分系统，用户每次使用功能需消耗积分，同时可通过分享获得积分。

**具体功能**：
- **积分规则**：
  - 新用户注册即赠送50个积分。
  - 每次使用一次消耗10个积分。
- **分享功能**：允许用户以链接方式分享应用，成功分享链接且有新用户通过分享链接注册，则分享者获得30个积分。
- **积分管理**：在用户账户中显示当前积分余额，并记录积分变动历史。
- **防刷机制**：基本的防止恶意刷积分的安全措施。

### 2.4 第四期：实现支付功能
**目标**：为用户提供购买额外积分的功能，支持国际支付。

**具体功能**：
- **支付集成**：选择Stripe作为支付网关，支持多种货币。
- **购买积分**：用户可以购买不同金额的积分包。
- **使用量限制**：根据用户拥有的积分数量控制其使用功能的次数。
- **交易记录**：提供用户支付和积分购买历史记录。

## 3. 用户界面和用户体验设计

### 3.1 首页设计
- **布局**：简洁的单页应用设计，顶部为导航栏，中间为主要内容区域，底部为页脚
- **导航栏**：包含Logo、主页链接、用户头像/登录按钮、积分余额显示
- **主要内容区**：
  - 输入框：大型文本输入区域，带有占位文本"请输入想要嘲讽的对象或情境..."
  - 生成按钮：醒目的主色调按钮，带有加载动画效果
  - 结果展示区：美观的卡片式设计，显示生成的内容，带有复制和分享按钮
- **页脚**：包含版权信息、使用条款链接、隐私政策链接

### 3.2 用户面板
- **个人信息**：头像、用户名、邮箱、注册日期
- **积分管理**：当前积分余额、积分获取历史、积分消费历史
- **分享管理**：个人分享链接、分享统计（点击次数、成功邀请人数）
- **设置**：通知设置、账户安全设置

### 3.3 响应式设计
- 适配桌面、平板和移动设备的不同屏幕尺寸
- 移动端优化：简化界面元素，确保良好的触摸体验

### 3.4 交互设计
- 生成内容时的加载动画
- 积分变动时的视觉反馈
- 操作成功/失败的提示信息
- 平滑的页面过渡效果

## 4. 数据库架构设计（Supabase）

### 4.1 表结构设计

1. **用户表（由Supabase Auth自动管理）**
   - `id`: UUID (主键)
   - `email`: 字符串
   - `created_at`: 时间戳
   - `last_sign_in`: 时间戳

2. **用户资料表（profiles）**
   - `id`: UUID (主键，关联auth.users表)
   - `name`: 字符串
   - `avatar_url`: 字符串
   - `points`: 整数 (默认值: 50)
   - `created_at`: 时间戳
   - `updated_at`: 时间戳

3. **积分交易记录表（point_transactions）**
   - `id`: UUID (主键)
   - `user_id`: UUID (外键，关联profiles表)
   - `amount`: 整数 (可正可负)
   - `type`: 枚举类型 ('registration', 'generation', 'referral', 'purchase')
   - `description`: 字符串
   - `created_at`: 时间戳
   - `updated_at`: 时间戳

4. **分享记录表（share_clicks）**
   - `id`: UUID (主键)
   - `sharer_id`: UUID (外键，关联profiles表)
   - `visitor_id`: UUID (可为空，关联profiles表)
   - `logged_in`: 布尔值
   - `rewarded`: 布尔值
   - `created_at`: 时间戳
   - `updated_at`: 时间戳

5. **推荐关系表（referrals）**
   - `id`: UUID (主键)
   - `referrer_id`: UUID (外键，关联profiles表)
   - `referred_id`: UUID (外键，关联profiles表)
   - `created_at`: 时间戳
   - 唯一约束：`referred_id` (确保每个用户只能被推荐一次)

6. **内容生成记录表（generations）**
   - `id`: UUID (主键)
   - `user_id`: UUID (外键，关联profiles表)
   - `target`: 字符串 (用户输入的目标)
   - `result`: 文本 (生成的内容)
   - `points_consumed`: 整数
   - `created_at`: 时间戳

7. **支付记录表（payments）** (第四期)
   - `id`: UUID (主键)
   - `user_id`: UUID (外键，关联profiles表)
   - `amount`: 浮点数 (支付金额)
   - `currency`: 字符串 (货币类型)
   - `points_added`: 整数 (购买的积分数量)
   - `payment_id`: 字符串 (Stripe支付ID)
   - `status`: 枚举类型 ('pending', 'completed', 'failed')
   - `created_at`: 时间戳
   - `updated_at`: 时间戳

### 4.2 索引设计
- 为所有外键创建索引
- 为 `point_transactions` 表的 `type` 和 `created_at` 字段创建索引
- 为 `share_clicks` 表的 `sharer_id` 和 `visitor_id` 字段创建索引
- 为 `generations` 表的 `user_id` 和 `created_at` 字段创建索引

### 4.3 行级安全策略（RLS）
- 用户只能查看和修改自己的资料
- 用户只能查看自己的积分交易记录
- 用户只能查看与自己相关的分享记录
- 管理员可以查看所有记录

## 5. API设计和接口规范

### 5.1 认证相关API
1. **登录/注册**
   - 路径: `/api/auth/callback`
   - 方法: GET
   - 功能: 处理Supabase认证回调
   - 返回: 重定向到首页或登录页

2. **获取当前用户**
   - 路径: `/api/auth/user`
   - 方法: GET
   - 功能: 获取当前登录用户信息
   - 返回: 用户信息对象

### 5.2 内容生成API
1. **生成内容**
   - 路径: `/api/generate`
   - 方法: POST
   - 请求体: 包含目标对象信息
   - 功能: 根据用户输入生成嘲讽内容，消耗积分
   - 返回: 生成结果和剩余积分
   - 错误处理: 包括未授权、参数无效、积分不足等情况

### 5.3 积分相关API
1. **获取积分历史**
   - 路径: `/api/points/history`
   - 方法: GET
   - 参数: 分页参数
   - 功能: 获取用户积分变动历史
   - 返回: 交易记录列表和分页信息

2. **获取积分统计**
   - 路径: `/api/points/stats`
   - 方法: GET
   - 功能: 获取用户积分统计信息
   - 返回: 积分统计数据

### 5.4 分享相关API
1. **记录分享点击**
   - 路径: `/api/share/click`
   - 方法: POST
   - 请求体: 包含分享者ID
   - 功能: 记录分享链接被点击
   - 返回: 操作结果

2. **获取分享统计**
   - 路径: `/api/share/stats`
   - 方法: GET
   - 功能: 获取用户分享统计
   - 返回: 分享统计数据

### 5.5 支付相关API (第四期)
1. **创建支付意向**
   - 路径: `/api/payments/create-intent`
   - 方法: POST
   - 请求体: 包含积分包ID和货币类型
   - 功能: 创建Stripe支付意向
   - 返回: 支付信息和客户端密钥

2. **确认支付**
   - 路径: `/api/payments/confirm`
   - 方法: POST
   - 请求体: 包含支付意向ID
   - 功能: 确认支付并添加积分
   - 返回: 操作结果和积分信息

### 5.6 API响应格式规范
- 成功响应: 包含数据和成功标志
- 错误响应: 包含错误信息、详细信息和失败标志

## 6. 安全性和隐私保护措施

### 6.1 用户认证安全
1. **基于Supabase Auth的认证系统**
   - 使用OAuth 2.0协议进行第三方登录
   - 实现JWT令牌认证
   - 令牌自动刷新机制
   - 会话管理

### 6.2 数据安全
1. **数据库安全**
   - 使用Supabase的行级安全策略(RLS)
   - 为每个表定义精确的访问控制策略

2. **API安全**
   - 认证要求
   - 请求速率限制
   - CORS配置
   - 输入验证和清洗

### 6.3 内容安全
1. **内容审核机制**
   - 关键词过滤

2. **防止滥用**
   - 验证码机制
   - 积分消耗机制
   - 异常行为检测

### 6.4 隐私保护
1. **隐私政策**
   - 数据收集说明
   - 数据使用目的
   - 用户权利
   - Cookie使用说明
   - 第三方服务数据共享说明

## 7. 积分系统详细设计

### 7.1 积分获取途径
1. **注册奖励**
   - 新用户注册后自动获得50积分
   - 通过触发器或API调用实现

2. **推荐奖励**
   - 被推荐用户注册后，推荐人获得30积分
   - 防刷机制确保每个新用户只能被推荐一次
   - 详细的推荐流程实现

3. **购买积分**（第四期）
   - 多种积分套餐选择
   - 支持多种货币支付
   - 支付成功后立即添加积分

### 7.2 积分消费规则
1. **内容生成**
   - 每次生成内容消耗10积分
   - 积分不足时提示用户
   - 详细的实现逻辑

### 7.3 积分管理和显示
1. **积分余额显示**
   - 导航栏显示当前积分
   - 实时更新机制
   - 动画效果强调变化

2. **积分历史记录**
   - 详细的交易记录
   - 筛选和排序功能
   - 分页显示

3. **积分统计分析**
   - 可视化图表展示
   - 使用趋势分析
   - 剩余使用次数预估

### 7.4 积分系统安全措施
1. **防刷机制**
   - IP地址限制
   - 设备指纹识别
   - 异常行为监控

2. **交易一致性**
   - 数据库事务确保原子性
   - 补偿机制处理失败操作
   - 定期对账机制

## 8. 分享功能详细设计

### 8.1 分享链接生成
1. **链接格式**
   - 基本URL参数格式
   - 短链接服务
   - 唯一分享链接

2. **分享渠道集成**
   - 多种社交媒体平台
   - 直接复制链接

3. **分享界面设计**
   - 弹出式对话框
   - 预设和自定义分享文案
   - 分享预览功能

### 8.2 分享追踪机制
1. **点击追踪**
   - 记录详细的点击信息
   - URL参数和cookie追踪

3. **奖励发放**
   - 自动奖励机制
   - 推荐奖励通知
   - 实时积分更新

## 9. 内容生成和审核机制详细设计

### 9.1 DeepSeek API集成
1. **API调用流程**
   - 完整的请求处理流程
   - 用户验证和积分检查
   - 内容生成和审核

2. **API参数配置**
   - 详细的模型参数设置
   - 系统提示词设计
   - 温度和采样参数优化

3. **错误处理和重试机制**
   - 超时处理
   - 退避重试策略
   - 备用响应机制

### 9.2 内容审核机制
1. **自动审核**
   - 关键词过滤
   - 情感分析
   - 内容分类

### 9.3 内容优化
1. **内容展示优化**
   - 排版和字体设计
   - 复制和分享功能
   - 历史内容管理

### 9.4 内容生成限制
1. **频率限制**
   - 基于积分的限制
   - 时间窗口限制

2. **并发请求限制**
   - 单用户并发限制
   - 系统总并发控制

## 10. 非功能性需求

- **安全性**：确保所有数据传输加密，遵守GDPR等相关法规。
- **用户体验**：设计简洁直观的用户界面，保证操作便捷性。
- **性能优化**：确保应用响应速度快，特别是在API请求处理方面。
- **内容合规**：实施内容审核机制，防止生成违法或不当内容。
- **可扩展性**：系统架构设计应考虑未来功能扩展的可能性。

## 11. 技术栈选择

- **前端框架**：Next.js (App Router)
- **样式**：Tailwind CSS + Shadcn UI
- **后端**：Next.js API Routes
- **数据库**：Supabase (PostgreSQL)
- **认证**：Supabase Auth
- **部署**：Vercel
- **其他依赖**：
  - DeepSeek API (内容生成)
  - Stripe (支付处理)
